---
title: js-proxy
date: 2020-08-18 18:14:50
tags: js-proxy æ‹¦æˆªå¯¹è±¡ å¯¹è±¡ä»£ç†
categories: å‰ç«¯
---

### What

**Proxy** æ˜¯ ES6 ä¸­æ–°å¢çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥ç”¨æ¥è‡ªå®šä¹‰å¯¹è±¡ä¸­çš„æ“ä½œã€‚
Proxy å¯ä»¥ç†è§£æˆï¼Œåœ¨ç›®æ ‡å¯¹è±¡ä¹‹å‰æ¶è®¾ä¸€å±‚â€œæ‹¦æˆªâ€ï¼Œå¤–ç•Œå¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œéƒ½å¿…é¡»å…ˆé€šè¿‡è¿™å±‚æ‹¦æˆªï¼Œå› æ­¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥å¯¹å¤–ç•Œçš„è®¿é—®è¿›è¡Œè¿‡æ»¤å’Œæ”¹å†™ã€‚Proxy è¿™ä¸ªè¯çš„åŸæ„æ˜¯ä»£ç†ï¼Œç”¨åœ¨è¿™é‡Œè¡¨ç¤ºç”±å®ƒæ¥â€œä»£ç†â€æŸäº›æ“ä½œï¼Œå¯ä»¥è¯‘ä¸ºâ€œä»£ç†å™¨â€ã€‚

[å®˜ç½‘é“¾æ¥](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy)

### How

```
const p = new Proxy(target, handler)

```

target
è¦ä½¿ç”¨ Proxy åŒ…è£…çš„ç›®æ ‡å¯¹è±¡ï¼ˆå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬åŸç”Ÿæ•°ç»„ï¼Œå‡½æ•°ï¼Œç”šè‡³å¦ä¸€ä¸ªä»£ç†ï¼‰ã€‚
handler
ä¸€ä¸ªé€šå¸¸ä»¥å‡½æ•°ä½œä¸ºå±æ€§çš„å¯¹è±¡ï¼Œå„å±æ€§ä¸­çš„å‡½æ•°åˆ†åˆ«å®šä¹‰äº†åœ¨æ‰§è¡Œå„ç§æ“ä½œæ—¶ä»£ç† p çš„è¡Œä¸ºã€‚

handler.has()
in æ“ä½œç¬¦çš„æ•æ‰å™¨ã€‚
handler.get()
å±æ€§è¯»å–æ“ä½œçš„æ•æ‰å™¨ã€‚
handler.set()
å±æ€§è®¾ç½®æ“ä½œçš„æ•æ‰å™¨ã€‚

ä¸¾ä¸ª ğŸŒ°

```
const handler = {
    get: function(obj, prop) {
        return prop in obj ? obj[prop] : 37;
    }
};

const p = new Proxy({}, handler);
p.a = 1;
p.b = undefined;

console.log(p.a, p.b);      // 1, undefined
console.log('c' in p, p.c); // false, 37

//  è¿™æ˜¯ä¸€æ¡åˆ†å‰²çº¿ ================

//  è½¬å‘æ“ä½œ
let target = {};
let p = new Proxy(target, {});

p.a = 37;   // æ“ä½œè½¬å‘åˆ°ç›®æ ‡

console.log(target.a);    // 37. æ“ä½œå·²ç»è¢«æ­£ç¡®åœ°è½¬å‘


//  è¿™ä¹Ÿæ˜¯ä¸€æ¡åˆ†å‰²çº¿  ===================

// ç”¨äºæ ¡éªŒï¼Œä¹Ÿå¾ˆok

let validator = {
  set: function(obj, prop, value) {
    if (prop === 'age') {
      if (!Number.isInteger(value)) {
        throw new TypeError('The age is not an integer');
      }
      if (value > 200) {
        throw new RangeError('The age seems invalid');
      }
    }

    // The default behavior to store the value
    obj[prop] = value;

    // è¡¨ç¤ºæˆåŠŸ
    return true;
  }
};

let person = new Proxy({}, validator);

person.age = 100;

console.log(person.age);
// 100

person.age = 'young';
// æŠ›å‡ºå¼‚å¸¸: Uncaught TypeError: The age is not an integer

person.age = 300;
// æŠ›å‡ºå¼‚å¸¸: Uncaught RangeError: The age seems invalid




```

è¿˜å¯ä»¥æ‰©å±•æ„é€ å‡½æ•°ï¼Œ
è¿˜å¯ä»¥æ“ä½œ domï¼Œæ¯”å¦‚äº’æ¢ä¸¤ä¸ªä¸åŒå…ƒç´ çš„å±æ€§æˆ–ç±»å

é‡ç‚¹åœ¨äºï¼Œæ‹¦æˆª => æ“ä½œ
è¿™ä¸ªå®˜ç½‘å†™çš„æŒºå…¨é¢ï¼Œå¦‚æœæœ‰éœ€è¦å°±ç‚¹å‡»ä¸Šé¢é‚£ä¸ªé“¾æ¥åˆ°å®˜ç½‘çœ‹å§ï½

### ç›¸å…³

#### Reflect

```
//  æˆ‘å†åˆ†å‰²ä¸€æ³¢ ==============================

//  çœ‹äº†ä¸‹é¢èƒ½æ›´å¥½çš„ç†è§£ï¼Œç†è§£ï¼Œä¼šç”¨ï¼Œå°±okï¼ è¿™é‡Œæœ‰ä¸ªreflect ä»£ç ä¸‹é¢æ–‡å­—è§£æä¸€æ³¢
let onWatch = (obj, setBind, getLogger) => {
  let handler = {
    get(target, property, receiver) {
      getLogger(target, property)
      return Reflect.get(target, property, receiver)
    },
    set(target, property, value, receiver) {
      setBind(value, property)
      return Reflect.set(target, property, value)
    }
  }
  return new Proxy(obj, handler)
}

let obj = { a: 1 }
let p = onWatch(
  obj,
  (v, property) => {
    console.log(`ç›‘å¬åˆ°å±æ€§${property}æ”¹å˜ä¸º${v}`)
  },
  (target, property) => {
    console.log(`'${property}' = ${target[property]}`)
  }
)
p.a = 2 // ç›‘å¬åˆ°å±æ€§aæ”¹å˜
p.a // 'a' = 2


```

Reflect æ˜¯ä¸€ä¸ªå†…ç½®çš„å¯¹è±¡ï¼Œå®ƒæä¾›æ‹¦æˆª JavaScript æ“ä½œçš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¸ proxy handlers çš„æ–¹æ³•ç›¸åŒã€‚Reflect ä¸æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œå› æ­¤å®ƒæ˜¯ä¸å¯æ„é€ çš„ã€‚
Reflect çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼ˆå°±åƒ Math å¯¹è±¡ï¼‰ã€‚

_Reflect.apply(target, thisArgument, argumentsList)_
å¯¹ä¸€ä¸ªå‡½æ•°è¿›è¡Œè°ƒç”¨æ“ä½œï¼ŒåŒæ—¶å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ•°ç»„ä½œä¸ºè°ƒç”¨å‚æ•°ã€‚å’Œ Function.prototype.apply() åŠŸèƒ½ç±»ä¼¼ã€‚

_Reflect.get(target, propertyKey[, receiver])_
è·å–å¯¹è±¡èº«ä¸ŠæŸä¸ªå±æ€§çš„å€¼ï¼Œç±»ä¼¼äº target[name]ã€‚

_Reflect.has(target, propertyKey)_
åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨æŸä¸ªå±æ€§ï¼Œå’Œ in è¿ç®—ç¬¦ çš„åŠŸèƒ½å®Œå…¨ç›¸åŒ

_Reflect.set(target, propertyKey, value[, receiver])_
å°†å€¼åˆ†é…ç»™å±æ€§çš„å‡½æ•°ã€‚è¿”å›ä¸€ä¸ª Booleanï¼Œå¦‚æœæ›´æ–°æˆåŠŸï¼Œåˆ™è¿”å› trueã€‚

```
const duck = {
  name: 'Maurice',
  color: 'white',
  greeting: function() {
    console.log(`Quaaaack! My name is ${this.name}`);
  }
}

Reflect.has(duck, 'color');
// true
Reflect.has(duck, 'haircut');
// false


//  è¿˜æ˜¯ä¸€ä¸ªåˆ†å‰²çº¿ å“ˆå“ˆ====================

Reflect.set(duck, 'eyes', 'black');
// returns "true" if successful
// "duck" now contains the property "eyes: 'black'"

```

æ‰€ä»¥ä¸Šé¢çš„ä»£ç ä¸­
`return Reflect.set(target, property, value)`
è¿™å°±æ˜¯æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å±æ€§ ï¼Œä¾‹å¦‚ target : { property:value }

### ç»“æŸ

ok ï¼Œé‚£è¿™å°±æ˜¯ proxy ç›¸å…³çš„ä¸€äº›å†…å®¹ï¼Œè¿™é‡Œæ˜¯æœ±å†› â¤ï¸ \_bye ï½
